
services:
  web:
    image: "${WEB_IMAGE}:${GITHUB_SHA}"
    command: gunicorn "Application_Main".wsgi:application --bind 0.0.0.0:8000
    volumes:
      - static:/usr/src/app/static
      - base:/usr/src/app
      - type: bind
        source: $HOST/etc/letsencrypt/live/findmyitem.app/
        target: /usr/share/ssl_certs/
    ports:
      - 8000:8000
    env_file: .env
    networks:
      - application_connect

  nginx:
    image: "${NGINX_IMAGE}:${GITHUB_SHA}"
    restart: unless-stopped
    volumes:
      - static:/usr/src/app/static
      - type: bind
        source: $HOST/etc/letsencrypt/live/findmyitem.app/fullchain.pem
        target: /usr/share/ssl_certs/fullchain.pem
      - type: bind
        source: $HOST/etc/letsencrypt/live/findmyitem.app/privkey.pem
        target: /usr/share/ssl_certs/privkey.pem

    ports:
      - 80:80
      - 443:443
    depends_on:
      - web
    networks:
      - application_connect

  redis:
    restart: always
    image: redis:latest
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data

  celery:
    build:
      context: .
      dockerfile: Dockerfile.prod
    command: "celery -A Application_Main worker && celery -A Application_Main beat"
    depends_on:
      - web
      - redis
    restart: on-failure

networks:
  application_connect:
    external: true

volumes:
  static:
  base:
  redisdata:
